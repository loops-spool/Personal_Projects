<!DOCTYPE html>
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" type = "text/css" href="style.css/?version1">
   </head>
   <body class = "scaled">

      <form action = "/" method = "POST" id = "led settings" name = "led settings">

         <label for = "effect">Effects:</label>
         <br>
         <select name = "effect" id = "effect" onchange = "this.form.submit()">
            <option value = "Off">Off</option>
            <option value = "" disabled></option>

            <optgroup label = "Static Effects">
               <option value = "Color">Color</option>
               <option value = "Static alternating colors">Alternating colors</option>
            </optgroup>
            <option value = "" disabled></option>

            <optgroup label = "Animated Effects">
               <option value = "Animated alternating colors">Alternating colors</option>
               <option value = "Twinkle">Twinkle</option>
               <option value = "Random">Random</option>
            </optgroup>
         </select>
         <br>
         <br>

         <label for = "colors" id = "colors label" name = "colors label">Color:</label>
         <br>
         <div id = "colors">
            <input type = "color" name = "color0" id = "color0" value = "#FF4614" onchange = "this.form.submit()">
            <input type = "color" name = "color1" id = "color1" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color2" id = "color2" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color3" id = "color3" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color4" id = "color4" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color5" id = "color5" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color6" id = "color6" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color7" id = "color7" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color8" id = "color8" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color9" id = "color9" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">

            <br>

            <input type = "button" value = "Add color" id = "add color button" name = "add color button">
            <input type = "button" value = "Remove color" id = "remove color button" name = "remove color button">
            <input type = "number" defaultValue = 1 value = 1 min = 1 max = 10 id = "amount of colors" name = "amount of colors" style = "display:none;">
         </div>
         <br>

         <label for = "mult brightnesses checkbox" id = "mult brightnesses checkbox label" name = "mult brightnesses checkbox label" style = "display:none;">Enable multiple brightnesses</label>
         <input type = "checkbox" id = "mult brightnesses checkbox" name = "mult brightnesses checkbox" value = "True" style = "display:none;" onchange = "this.form.submit()">
         <br>
         <br>

         <label for = "brightness" id = "brightness label" name = "brightness label">Brightness:</label>
         <div id = "brightnesses">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness0" id = "brightness0" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness1" id = "brightness1" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness2" id = "brightness2" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness3" id = "brightness3" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness4" id = "brightness4" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness5" id = "brightness5" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness6" id = "brightness6" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness7" id = "brightness7" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness8" id = "brightness8" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness9" id = "brightness9" style = "display:none;" onchange="this.form.submit()">
         </div>
         <br>

         <label for = "animated speed slider" id = "animated speed slider label" name = "animated speed slider label" style = "display:none;">Animated Effect Speed</label>
         <br>
         <div>
            <input type = "range" min = "0" max = "100" value = "50" name = "animated speed slider" id = "animated speed slider" style = "display:none;" onchange="this.form.submit()">
         </div>
         <br>
         <h4>Raspberry Pi temperature is: {{ temp }}</h4>


         <script>
            const form = document.getElementById("led settings");
            const form_elements = form.elements; // HTMLFormControlsCollection
            const colors = document.querySelectorAll('input[type=color]'); // NodeList
            const brightnesses = document.getElementById('brightnesses').children;  // HTMLCollection
            const labels = document.getElementsByTagName('LABEL'); // HTMLCollection

            function hide(...elements)
            {
               for (let i = 0; i < elements.length; i++)
               {
                  if (elements[i].constructor === NodeList)
                  {
                     for (let node of elements[i])
                        node.style = "display:none;";
                  }
                  else
                     elements[i].style = "display:none;";
               }
            }

            function hide_all_except_from(source, except)
            {
               if (source.constructor === HTMLFormControlsCollection ||
                   source.constructor === HTMLCollection)
               {
                  for (let i = 0; i < source.length; i++)
                  {
                     if (except.includes(source[i]))
                        continue;
                     else
                        source[i].style = "display:none;"
                  }
               }
            }

            function show(...elements)
            {
               for (let i = 0; i < elements.length; i++)
               {
                  if (elements[i].constructor === NodeList)
                  {
                     for (let node of elements[i])
                        node.style = "display:none;";
                  }
                  else
                     elements[i].style = "display:inline;";
               }
            }

            // This is a workaround to update amount of colors localStorage
            // Fires change event when changing value through js .value =
            var changed = new Event('change');

            // Keeps track of amount of colors
            form_elements["add color button"].addEventListener('click', inc_color);
            form_elements["remove color button"].addEventListener('click', dec_color);

            function inc_color()
            {
               num = parseInt(form_elements["amount of colors"].value);
               if (num < form_elements["amount of colors"].max)
               {
                  num++;
                  form_elements["amount of colors"].value = num;
                  form_elements["amount of colors"].dispatchEvent(changed);
                  form.submit();
               }
            }

            function dec_color()
            {
               num = parseInt(form_elements["amount of colors"].value);
               if (num > form_elements["amount of colors"].min)
               {
                  num--;
                  form_elements["amount of colors"].value = num;
                  form_elements["amount of colors"].dispatchEvent(changed);
                  form.submit();
               }
            }

            // Saves form values across refreshes/form submits
            for(let i = 0; i < form_elements.length; i++)
            {
               // Skips the add/remove color buttons since they don't need a change event listener
               if (form_elements[i].id == "add color" ||
                   form_elements[i].id == "remove color")
               {
                  continue;
               }

               // Saves value
               form_elements[i].addEventListener("change", function() {
                  // Since checkboxes don't have a value attribute, must use checked attribute
                  if (form_elements[i].id == "mult brightnesses checkbox")
                     localStorage.setItem(form_elements[i].id, this.checked);
                  else
                     localStorage.setItem(form_elements[i].id, this.value);
               });

               // Sets value
               let val = localStorage.getItem(form_elements[i].id);
               if (val) 
               {
                  // Since localStorage stores values only as strings
                  // Boolean values must be converted from a string back to boolean
                     // to be assigned to a checkbox checked attribute
                  if (form_elements[i].id == "mult brightnesses checkbox")
                     form_elements[i].checked = (val == 'true');
                  else
                     form_elements[i].value = val; 
               }
            }

            ///////////////////   SHOWING ELEMENTS  ///////////////////
            var effect_color_amounts = {
               "Off": 0,
               "Color": 1,
               "Static alternating colors": 2,
               "Animated alternating colors": 2,
               "Twinkle": 1,
               "Random": 2
            };

            var no_color_effects = [
               "Off",
               "Random"
            ];

            var animated_effects = [
               "Animated alternating colors",
               "Twinkle",
               "Random"
            ];

            var has_mult_brightnesses = form_elements["mult brightnesses checkbox"].checked;

            // Shows number of colors and brightnesses
            // Yet another workaround...
            // Can't be put in add/remove color button functions because form submit removes styling
            // Using localStorage because of accessing the value of amount of colors wasn't working
               // Something to do with value element and value property/ value = defaultValue/ etc
            let amount_of_colors = parseInt(localStorage.getItem(form_elements["amount of colors"].id));
            if (amount_of_colors) 
            {
               if (amount_of_colors > 1)
               {
                  show(labels["mult brightnesses checkbox label"]);
                  show(form_elements["mult brightnesses checkbox"]);
               }
               else
               {
                  hide(labels["mult brightnesses checkbox label"]);
                  hide(form_elements["mult brightnesses checkbox"]);
               }
               for (let i = 0; i < amount_of_colors; i++)
               {
                  show(colors[i]);
                  if (has_mult_brightnesses)
                     show(brightnesses[i]);
               }
            }

            // TODO: Finish filling these out for current effects
            // TODO: Maybe implement a hide all except function for node lists and HTML collections
            if (no_color_effects.includes(form_elements["effect"].value))
            {
               // Hides color elements
               hide(colors);
               hide(labels["colors label"],
                    form_elements["add color button"],
                    form_elements["remove color button"]);

               if (form_elements["effect"].value == "Off")
               {
                  hide(labels["brightness label"],
                       form_elements["brightness0"]);
               }

               // Hides brightness elements

            }

            // TODO: Change this based off of amount of colors
               // Also certain functions
            // This script shows multiple color selectors for the effect if needed
            switch (effect_color_amounts[form_elements["effect"].value])
            {
               case 1:
                  labels["colors label"].style = "display:inline;";
                  //form_elements["color1"].style.visibility = "hidden";
                  //form_elements["mult brightnesses checkbox"].style = "display:none;";
                  //labels["mult brightnesses checkbox label"].style = "display:none;";
                  break;
               
               case 2:
                  labels["colors label"].style = "display:inline;";
                  //form_elements["color1"].style.visibility = "visible";
                  labels["mult brightnesses checkbox label"].style = "display:inline;";
                  form_elements["mult brightnesses checkbox"].style = "display:inline;";

                  if (has_mult_brightnesses == true)
                     form_elements["brightness1"].style = "display:inline;";
                  else
                     form_elements["brightness1"].style = "display:none;";

                  break;

               case 3:
                  break;

               default:
                  //labels["colors label"].style = "display:inline;";
                  //form_elements["color1"].style.visibility = "hidden";
                  form_elements["mult brightnesses checkbox"].style = "display:none;";
                  labels["mult brightnesses checkbox label"].style = "display:none;";
                  break;
            }

            if (animated_effects.includes(form_elements["effect"].value))
            {
               labels["animated speed slider label"].style = "display:inline;";
               form_elements["animated speed slider"].style = "display:inline;";
            }
            else
            {
               labels["animated speed slider label"].style = "display:none;";
               form_elements["animated speed slider"].style = "display:none;";
            }

            // TODO: Put this as 0 into the dictionary for effect colors
               // Then just add a 0 case
            if (form_elements["effect"].value == "Random")
            {
               labels["colors label"].style = "display:none;";
               form_elements["color0"].style.visibility = "hidden";
               form_elements["color1"].style.visibility = "hidden";
               form_elements["mult brightnesses checkbox"].style = "display:none;";
               labels["mult brightnesses checkbox label"].style = "display:none;";
               form_elements["brightness1"].style = "display:none;";
            }

         </script>
         
      </form>
      
   </body>
</html>