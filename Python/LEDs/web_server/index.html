<!DOCTYPE html>
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" type = "text/css" href="style.css/?version1">
   </head>
   <body class = "scaled">

      <form action = "/" method = "POST" id = "led settings" name = "led settings">

         <label for = "effect">Effects:</label>
         <br>
         <select name = "effect" id = "effect" onchange = "this.form.submit()">
            <option value = "Off">Off</option>
            <option value = "" disabled></option>

            <optgroup label = "Static Effects">
               <option value = "Single color">Single color</option>
               <option value = "Static alternating colors">Alternating colors</option>
            </optgroup>
            <option value = "" disabled></option>

            <optgroup label = "Animated Effects">
               <option value = "Animated alternating colors">Alternating colors</option>
               <option value = "Twinkle">Twinkle</option>
               <option value = "Random">Random</option>
            </optgroup>
         </select>
         <br>
         <br>

         <label for = "colors" id = "colors label" name = "colors label">Color:</label>
         <br>
         <div id = "colors">
            <input type = "color" name = "color0" id = "color0" value = "#FF4614" onchange = "this.form.submit()">
            <input type = "color" name = "color1" id = "color1" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color2" id = "color2" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color3" id = "color3" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color4" id = "color4" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color5" id = "color5" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color6" id = "color6" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color7" id = "color7" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color8" id = "color8" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">
            <input type = "color" name = "color9" id = "color9" value = "#FF4614" visibility = "hidden" onchange = "this.form.submit()">

            <input type = "button" value = "Add color" id = "add color" name = "add color">
            <input type = "button" value = "Remove color" id = "remove color" name = "remove color">
            <input type = "number" value = 1 min = 1 max = 10 id = "amount of colors" name = "amount of colors" style = "display:none;">
         </div>
         <br>

         <label for = "mult brightnesses checkbox" id = "mult brightnesses checkbox label" name = "mult brightnesses checkbox label" style = "display:none;">Enable multiple brightnesses</label>
         <input type = "checkbox" id = "mult brightnesses checkbox" name = "mult brightnesses checkbox" value = "True" style = "display:none;" onchange = "this.form.submit()">
         <br>
         <br>

         <label for = "brightness">Brightness:</label>
         <div>
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness0" id = "brightness0" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness1" id = "brightness1" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness2" id = "brightness2"  style = "display:none;" onchange="this.form.submit()">
         </div>
         <br>

         <label for = "animated speed slider" id = "animated speed slider label" name = "animated speed slider label" style = "display:none;">Animated Effect Speed</label>
         <br>
         <div>
            <input type = "range" min = "0" max = "100" value = "50" name = "animated speed slider" id = "animated speed slider" style = "display:none;" onchange="this.form.submit()">
         </div>


         <script>
            var form = document.getElementById("led settings");

            // This is a workaround to update amount of colors localStorage
            // Fires onchange event when changing value through js .value =
            var changed = new Event('change');

            const add_color_button = document.getElementById("add color");
            const remove_color_button = document.getElementById("remove color");
            const amount_of_colors = document.getElementById("amount of colors");

            add_color_button.addEventListener('click', inc_color);
            remove_color_button.addEventListener('click', dec_color);

            function inc_color()
            {
               num = parseInt(amount_of_colors.value);
               if (num < amount_of_colors.max)
               {
                  num++;
                  amount_of_colors.value = num;
                  amount_of_colors.dispatchEvent(changed);
                  form.submit();
               }
            }

            function dec_color()
            {
               num = parseInt(amount_of_colors.value);
               if (num > amount_of_colors.min)
               {
                  num--;
                  amount_of_colors.value = num;
                  amount_of_colors.dispatchEvent(changed);
                  form.submit();
               }
            }


            const effect = document.getElementById("effect");
            const color0 = document.getElementById("color0");
            const color1 = document.getElementById("color1");
            const color2 = document.getElementById("color1");
            const color3 = document.getElementById("color0");
            const color4 = document.getElementById("color1");
            const color5 = document.getElementById("color1");
            const color6 = document.getElementById("color0");
            const color7 = document.getElementById("color1");
            const color8 = document.getElementById("color1");
            const color9 = document.getElementById("color1");
            const animated_speed_slider = document.getElementById("animated speed slider");
            const mult_brightnesses_checkbox = document.getElementById("mult brightnesses checkbox");
            const brightness0 = document.getElementById("brightness0");
            const brightness1 = document.getElementById("brightness1");
            const brightness2 = document.getElementById("brightness2");

            console.log(document.getElementById("led settings").elements);

            var form_elements = [
               effect,
               amount_of_colors,
               color0,
               color1,
               animated_speed_slider,
               mult_brightnesses_checkbox,
               brightness0,
               brightness1,
               brightness2
            ];

            var form_elements_storage_name = [
               "effect",
               "amount of colors",
               "color0",
               "color1",
               "animated speed slider",
               "mult brightnesses checkbox",
               "brightness0",
               "brightness1",
               "brightness2"
            ];

            // Saves form values across refreshes
            for(let i = 0; i < form_elements.length; i++)
            {
               // Saves value
               form_elements[i].addEventListener("change", function() {
                  // Since checkboxes don't have a value attribute, must use checked attribute
                  if (form_elements_storage_name[i] == "mult brightnesses checkbox")
                     localStorage.setItem(form_elements_storage_name[i], this.checked);
                  else
                     localStorage.setItem(form_elements_storage_name[i], this.value);
               });

               // Sets value
               let val = localStorage.getItem(form_elements_storage_name[i]);
               if (val) 
               {
                  // Since localStorage stores values only as strings
                  // Boolean values must be converted from a string back to boolean
                     // to be assigned to a checkbox checked attribute
                  if (form_elements_storage_name[i] == "mult brightnesses checkbox")
                     form_elements[i].checked = (val == 'true');
                  else
                     form_elements[i].value = val; 
               }
            }


            var effect_color_amounts = {
               "Off": 1,
               "Single color": 1,
               "Static alternating colors": 2,
               "Animated alternating colors": 2,
               "Twinkle": 1,
               "Random": 2
            };

            var animated_effects = [
               "Animated alternating colors",
               "Twinkle",
               "Random"
            ];

            var has_mult_brightnesses = mult_brightnesses_checkbox.checked;
            var mult_brightnesses_checkbox_label = document.getElementById("mult brightnesses checkbox label");
            var colors_label = document.getElementById("colors label");
            var animated_speed_label = document.getElementById("animated speed slider label");

            // This script shows multiple color selectors for the effect if needed
            switch (effect_color_amounts[effect.value])
            {
               case 1:
                  colors_label.style = "display:inline;";
                  color1.style.visibility = "hidden";
                  mult_brightnesses_checkbox.style = "display:none;";
                  mult_brightnesses_checkbox_label.style = "display:none;";
                  break;
               
               case 2:
                  colors_label.style = "display:inline;";
                  color1.style.visibility = "visible";
                  mult_brightnesses_checkbox_label.style = "display:inline;";
                  mult_brightnesses_checkbox.style = "display:inline;";

                  if (has_mult_brightnesses == true)
                     brightness1.style = "display:inline;";
                  else
                     brightness1.style = "display:none;";

                  break;

               case 3:
                  break;

               default:
                  colors_label.style = "display:inline;";
                  color1.style.visibility = "hidden";
                  mult_brightnesses_checkbox.style = "display:none;";
                  mult_brightnesses_checkbox_label.style = "display:none;";
                  break;
            }

            // Twinkle not included for some reason?
            if (animated_effects.includes(effect.value))
            {
               animated_speed_label.style = "display:inline;";
               animated_speed_slider.style = "display:inline;";
            }
            else
            {
               animated_speed_label.style = "display:none;";
               animated_speed_slider.style = "display:none;";
            }

            // TODO: Put this as 0 into the dictionary for effect colors
               // Then just add a 0 case
            if (effect.value == "Random")
            {
               colors_label.style = "display:none;";
               color0.style.visibility = "hidden";
               color1.style.visibility = "hidden";
               mult_brightnesses_checkbox.style = "display:none;";
               mult_brightnesses_checkbox_label.style = "display:none;";
               brightness1.style = "display:none;";
            }

            // if (amount_of_colors.value == 2)
            //    color1.style.visibility = "visible";
            // else
            //     color1.style.visibility = "hidden";
         </script>
         
      </form>
      
   </body>
</html>