<!DOCTYPE html>
   <head>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <link rel="stylesheet" type = "text/css" href="style.css/?version1">
   </head>
   <body class = "scaled">

      <form action = "/" method = "POST" id = "led settings" name = "led settings">

         <label for = "effect" id = "effect label" name = "effect label">Effects:</label>
         <br>
         <select name = "effect" id = "effect" onchange = "this.form.submit()">
            <option value = "Off">Off</option>
            <option value = "" disabled></option>

            <optgroup label = "Static Effects">
               <option value = "Color">Color</option>
            </optgroup>
            <option value = "" disabled></option>

            <optgroup label = "Animated Effects">
               <option value = "Animated alternating colors">Alternating colors</option>
               <option value = "Twinkle">Twinkle</option>
               <option value = "Random">Random</option>
            </optgroup>
         </select>
         <br>
         <br>

         <label for = "colors" id = "colors label" name = "colors label">Color:</label>
         <br>
         <div id = "colors">
            <input type = "color" name = "color0" id = "color0" value = "#FF4614" onchange = "this.form.submit()">
            <input type = "color" name = "color1" id = "color1" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color2" id = "color2" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color3" id = "color3" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color4" id = "color4" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color5" id = "color5" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color6" id = "color6" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color7" id = "color7" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color8" id = "color8" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">
            <input type = "color" name = "color9" id = "color9" value = "#FF4614" style = "display:none;" onchange = "this.form.submit()">

            <br>

            <input type = "button" value = "Add color" id = "add color button" name = "add color button" onclick = "inc_color()">
            <input type = "button" value = "Remove color" id = "remove color button" name = "remove color button" onclick = "dec_color()">
            <input type = "number" defaultValue = 1 value = 1 min = 1 max = 10 id = "amount of colors" name = "amount of colors" style = "display:none;">

            <br>
            <label for = "mult color style" id = "mult color style label" name = "mult color style label">Multiple color style:</label>
            <div id = "mult color style">
               <input type = "radio" name = "mult color style" id = "alternating style" value = "alternating" checked = "checked" onclick = "alternating_radio()">
               <label for = "alternating">Alternating</label>
               <input type = "radio" name = "mult color style" id = "block style"  value = "block" onclick = "block_radio()">
               <label for = "block">Block</label>
            </div>

         </div>
         <br>

         <label for = "mult brightnesses checkbox" id = "mult brightnesses checkbox label" name = "mult brightnesses checkbox label" style = "display:none;">Enable multiple brightnesses</label>
         <input type = "checkbox" id = "mult brightnesses checkbox" name = "mult brightnesses checkbox" value = "True" style = "display:none;" onchange = "this.form.submit()">
         <br>
         <br>

         <label for = "brightness" id = "brightness label" name = "brightness label">Brightness:</label>
         <div id = "brightnesses">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness0" id = "brightness0" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness1" id = "brightness1" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness2" id = "brightness2" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness3" id = "brightness3" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness4" id = "brightness4" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness5" id = "brightness5" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness6" id = "brightness6" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness7" id = "brightness7" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness8" id = "brightness8" style = "display:none;" onchange="this.form.submit()">
            <input type = "range" min = "0" max = "100" value = "50" name = "brightness9" id = "brightness9" style = "display:none;" onchange="this.form.submit()">
         </div>
         <br>

         <label for = "animated speed slider" id = "animated speed slider label" name = "animated speed slider label" style = "display:none;">Animated Effect Speed</label>
         <br>
         <div>
            <input type = "range" min = "0" max = "100" value = "50" name = "animated speed slider" id = "animated speed slider" style = "display:none;" onchange="this.form.submit()">
         </div>
         <br>
         <h4>Raspberry Pi temperature is: {{ temp }}</h4>


         <script>
            const form = document.getElementById("led settings");
            const form_elements = form.elements; // HTMLFormControlsCollection
            const colors = document.querySelectorAll('input[type=color]'); // NodeList
            const brightnesses = document.getElementById('brightnesses').children;  // HTMLCollection
            const labels = document.getElementsByTagName('LABEL'); // HTMLCollection

            var form_elements_arr = Array.prototype.slice.call(form_elements, 0);
            var labels_arr = Array.prototype.slice.call(labels, 0);
            const form_elements_wtih_labels = form_elements_arr.concat(labels_arr);

            function hide(...elements)
            {
               for (let i = 0; i < elements.length; i++)
               {
                  if (typeof(elements[i]) === 'string') // Checks if element is passed by id
                     document.getElementById(elements[i]).style = "display:none;";
                  if (typeof(elements[i]) === 'object') // Checks if element is passed by element
                     elements[i].style = "display:none;";
               }
            }

            function hide_all_except(...except)
            {
               for (let i = 0; i < form_elements_wtih_labels.length; i++)
               {
                  if (except.includes(form_elements_wtih_labels[i].id))
                     continue;
                  else
                     hide(form_elements_wtih_labels[i]);
               }
            }

            function show(...elements)
            {
               for (let i = 0; i < elements.length; i++)
               {
                  if (typeof(elements[i]) === 'string') // Checks if element is passed by id
                     document.getElementById(elements[i]).style = "display:inline;";
                  if (typeof(elements[i]) === 'object') // Checks if element is passed by element
                     elements[i].style = "display:inline;";
               }
            }

            // This is a workaround to update amount of colors localStorage
            // Fires change event when changing value through js
            var changed = new Event('change');

            // Keeps track of amount of colors
            function inc_color()
            {
               num = parseInt(form_elements["amount of colors"].value);
               if (num < form_elements["amount of colors"].max)
               {
                  num++;
                  form_elements["amount of colors"].value = num;
                  form_elements["amount of colors"].dispatchEvent(changed);
                  form.submit();
               }
            }

            function dec_color()
            {
               num = parseInt(form_elements["amount of colors"].value);
               if (num > form_elements["amount of colors"].min)
               {
                  num--;
                  form_elements["amount of colors"].value = num;
                  form_elements["amount of colors"].dispatchEvent(changed);
                  form.submit();
               }
            }

            // Since only one radio can be checked at a time
            // And my localStorage triggers onchange, which would only be setting the one to true, while the others true
               // The last radio defaults to true in that case
            // These explicitly set one to true, the other to false, push both to localStorage, and submit the form
            function alternating_radio()
            {
               form_elements["block style"].checked = false;
               form_elements["alternating style"].checked = true;
               form_elements["block style"].dispatchEvent(changed);
               form_elements["alternating style"].dispatchEvent(changed);
               form.submit();
            }

            function block_radio()
            {
               form_elements["alternating style"].checked = false;
               form_elements["block style"].checked = true;
               form_elements["block style"].dispatchEvent(changed);
               form_elements["alternating style"].dispatchEvent(changed);
               form.submit();
            }

            // TODO: Fix this to just add an event listener to each thing and not treat it as if it's in a for loop
            // Saves form values across refreshes/form submits
            for(let i = 0; i < form_elements.length; i++)
            {
               // Skips the add/remove color buttons since they don't need a change event listener
               if (form_elements[i].id == "add color" ||
                   form_elements[i].id == "remove color")
               {
                  continue;
               }

               // Saves value
               form_elements[i].addEventListener("change", function() {
                  // Since checkboxes don't have a value attribute, must use checked attribute
                  if (this.type === "checkbox" ||
                      this.type === "radio")
                        localStorage.setItem(this.id, this.checked);
                  else
                     localStorage.setItem(this.id, this.value);
               });

               // Sets value
               let val = localStorage.getItem(form_elements[i].id);
               if (val) 
               {
                  // Since localStorage stores values only as strings
                  // Boolean values must be converted from a string back to boolean
                     // to be assigned to a checked attribute
                  if (form_elements[i].type === "checkbox" ||
                      form_elements[i].type === "radio")
                  {
                     form_elements[i].checked = (val == 'true');
                  }
                  else
                     form_elements[i].value = val; 
               }
            }


            //////////////////////////////////////////////////// SHOWING/HIDING ELEMENTS ////////////////////////////////////////////////////

            // Only to check if animated effect speed slider should show
            var animated_effects = [
               "Animated alternating colors",
               "Twinkle",
               "Random"
            ];

            var has_mult_brightnesses = form_elements["mult brightnesses checkbox"].checked;

            // Shows number of colors and brightnesses
            // Yet another workaround...
            // Can't be put in add/remove color button functions because form submit removes styling
            // Using localStorage because of accessing the value of amount of colors wasn't working
               // Something to do with value element and value property/ value = defaultValue/ etc
            let amount_of_colors = parseInt(localStorage.getItem(form_elements["amount of colors"].id));
            if (amount_of_colors) 
            {
               // Shows multiple brightness information
               if (amount_of_colors > 1)
               {
                  show("mult brightnesses checkbox label", "mult brightnesses checkbox",
                       "mult color style label", "mult color style");
               }
               else
               {
                  hide("mult brightnesses checkbox label", "mult brightnesses checkbox",
                       "mult color style label", "mult color style");
               }
               // Shows colors and brightnesses
               for (let i = 0; i < amount_of_colors; i++)
               {
                  show(colors[i]);

                  if (has_mult_brightnesses)
                     show(brightnesses[i]);
               }
            }
      
            // Animated effects speed slider
            if (animated_effects.includes(form_elements["effect"].value))
               show("animated speed slider label", "animated speed slider");
            else
               hide("animated speed slider label", "animated speed slider");

            // Off call
            if (form_elements["effect"].value == "Off")
               hide_all_except("effect label", "effect");

            // Random call
            // TODO: This will eventually be taken out when the Random effect is converted into a random button
            if (form_elements["effect"].value == "Random")
            {
               hide_all_except("effect label",
                               "effect",
                               "brightness label",
                               "brightness0",
                               "animated speed slider label",
                               "animated speed slider",
                              );
            }

            // Temporarily hide
            hide("mult color style", "mult color style label");

         </script>
         
      </form>
      
   </body>
</html>